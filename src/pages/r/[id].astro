---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ResultsView from '../../components/ResultsView';
import RescanButton from '../../components/RescanButton';
import { kvGetJson } from '../../lib/kvJson';
import { computeTotal } from '../../lib/categories';
import { getGrade } from '../../lib/grades';
import type { AuditResult } from '../../lib/auditTypes';

export const prerender = false;

const id = (Astro.params.id ?? '').trim();
const env = (Astro.locals as any)?.runtime?.env as { RESULTS?: KVNamespace } | undefined;
const resultsKv = env?.RESULTS;

let stored: (AuditResult & { sharedAt?: string }) | null = null;
if (resultsKv && id) stored = await kvGetJson(resultsKv, `share:${id}`);

const found = !!stored;
const repoName = stored?.meta?.full_name ?? '';
const total = stored ? computeTotal(stored.scores) : 0;
const grade = getGrade(total);
const repoDesc = stored?.meta?.description ?? '';

const title = found
  ? `${repoName} scored ${total.toFixed(1)}/10 (${grade.letter}) · Repo Audit`
  : 'Shared Audit Not Found · Repo Audit';
const robots = found ? 'index,follow' : 'noindex,nofollow';
const description = found
  ? `${repoName} earned a ${grade.letter} grade (${total.toFixed(1)}/10) — ${grade.label}. ${repoDesc}`.trim()
  : 'Shared audit result not found.';

const site = Astro.site ?? new URL('https://repo-audit.coey.dev');
const ogParams = new URLSearchParams();
if (repoName) ogParams.set('repo', repoName);
if (total) ogParams.set('score', total.toFixed(1));
if (repoDesc) ogParams.set('desc', repoDesc.slice(0, 120));
const ogImage = found ? new URL(`/api/og.png?${ogParams.toString()}`, site).toString() : undefined;

const jsonLd = found ? {
  '@context': 'https://schema.org',
  '@type': 'SoftwareApplication',
  name: repoName,
  description: repoDesc || description,
  applicationCategory: 'DeveloperApplication',
  aggregateRating: {
    '@type': 'AggregateRating',
    ratingValue: total.toFixed(1),
    bestRating: '10',
    worstRating: '0',
    ratingCount: 1,
  },
} : undefined;
---

<BaseLayout title={title} description={description} robots={robots} ogImage={ogImage} jsonLd={jsonLd}>
  <main class="min-h-dvh px-4 py-10">
    <div class="mx-auto w-full max-w-2xl">
      <div class="mb-7 flex flex-wrap items-center justify-between gap-3">
        <a
          href="/"
          class="rounded-lg border border-border bg-surface px-3 py-2 font-mono text-[11px] text-dim transition hover:border-accent/40 hover:text-text"
        >
          home
        </a>
        <div class="flex items-center gap-2">
          <div class="font-mono text-[11px] text-dim">shared result</div>
          <button
            id="theme-toggle"
            type="button"
            class="rounded-lg border border-border bg-surface p-2 text-dim transition hover:border-accent/40 hover:text-text"
            aria-label="Toggle theme"
          >
            <svg id="icon-sun" class="hidden h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5" />
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
            </svg>
            <svg id="icon-moon" class="hidden h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
            </svg>
          </button>
        </div>
      </div>

      {found ? (
        <>
          {stored!.sharedAt ? (
            <div class="mb-3 font-mono text-[11px] text-dim">
              Shared {new Date(stored!.sharedAt).toLocaleString()}
            </div>
          ) : null}
          <ResultsView result={stored as AuditResult} />
          <div class="mt-8 flex flex-wrap items-start justify-center gap-3 pb-6">
            <a
              href="/"
              class="rounded-xl border border-border bg-surface px-5 py-3 font-mono text-xs text-muted transition hover:border-accent/40 hover:text-text"
            >
              Audit Another Repo
            </a>
            <RescanButton client:idle repo={repoName} />
          </div>
        </>
      ) : (
        <div class="rounded-2xl border border-border bg-surface p-6">
          <div class="font-display text-2xl text-text">Not found</div>
          <p class="mt-2 font-body text-sm leading-relaxed text-muted">
            This shared audit link is missing or expired. Shared results are stored for 30 days.
          </p>
          <div class="mt-5">
            <a
              href="/"
              class="inline-block rounded-xl border border-border bg-bg px-5 py-3 font-mono text-xs text-muted transition hover:border-accent/40 hover:text-text"
            >
              Run an audit
            </a>
          </div>
        </div>
      )}
    </div>
  </main>
</BaseLayout>
