---
import BaseLayout from '../layouts/BaseLayout.astro';
import RepoAuditApp from '../components/RepoAuditApp';
import { kvGetJson } from '../lib/kvJson';

export const prerender = false;

type GalleryItem = {
  id: string;
  url: string;
  full_name: string;
  total: number;
  grade: string;
  sharedAt: string;
  modelUsed: string | null;
};

const env = (Astro.locals as any)?.runtime?.env as { RESULTS?: KVNamespace } | undefined;
const resultsKv = env?.RESULTS;
const gallery =
  resultsKv
    ? ((await kvGetJson<{ items?: GalleryItem[] }>(resultsKv, 'gallery:latest'))?.items ?? [])
    : [];
---

<BaseLayout
  title="Repo Audit â€” Open-Source Repository Scoring"
  description="Score any GitHub repository in seconds. Deterministic analysis across 11 categories plus optional Workers AI insights. Free, fast, opinionated."
  jsonLd={{
    '@context': 'https://schema.org',
    '@type': 'WebApplication',
    name: 'Repo Audit',
    url: 'https://repo-audit.coey.dev',
    description: 'Score any GitHub repository in seconds. Deterministic analysis across 11 categories plus optional Workers AI insights.',
    applicationCategory: 'DeveloperApplication',
    operatingSystem: 'Any',
    offers: { '@type': 'Offer', price: '0', priceCurrency: 'USD' },
  }}
>
  <main class="min-h-dvh px-4 py-10">
    <div class="mx-auto w-full max-w-2xl">
      <div class="mb-8 flex items-end justify-between gap-4">
        <div>
          <div class="font-mono text-[11px] tracking-[.16em] text-dim">OPEN-SOURCE SCORING</div>
          <h1 class="font-display text-5xl leading-none tracking-tight">
            Repository <span class="font-bold italic text-accent">Audit</span>
          </h1>
          <p class="mt-3 max-w-[58ch] font-body text-sm leading-relaxed text-muted">
            Deterministic scoring plus an optional Workers AI qualitative pass. Designed for fast, opinionated repo triage.
          </p>
        </div>
        <div class="flex items-center gap-2">
          <button
            id="theme-toggle"
            type="button"
            class="rounded-lg border border-border bg-surface p-2 text-dim transition hover:border-accent/40 hover:text-text"
            aria-label="Toggle theme"
          >
            <svg id="icon-sun" class="hidden h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5" />
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
            </svg>
            <svg id="icon-moon" class="hidden h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
            </svg>
          </button>
          <a
            class="hidden rounded-lg border border-border bg-surface px-3 py-2 font-mono text-[11px] text-dim transition hover:border-accent/40 hover:text-text sm:inline-block"
            href="/matrix"
          >
            scoring matrix
          </a>
        </div>
      </div>

      <RepoAuditApp client:load initialGallery={gallery} />

      <div class="mt-10 flex flex-wrap items-center justify-between gap-3 border-t border-border pt-6">
        <div class="font-mono text-[11px] text-dim">
          Deployed on Cloudflare Workers. API: <span class="text-muted">/api/audit</span>
        </div>
        <div class="flex items-center gap-2">
          <a
            class="rounded-lg border border-border bg-surface px-3 py-2 font-mono text-[11px] text-dim transition hover:border-accent/40 hover:text-text"
            href="/docs"
          >
            docs
          </a>
          <a
            class="rounded-lg border border-border bg-surface px-3 py-2 font-mono text-[11px] text-dim transition hover:border-accent/40 hover:text-text sm:hidden"
            href="/matrix"
          >
            matrix
          </a>
          <a
            class="rounded-lg border border-border bg-surface px-3 py-2 font-mono text-[11px] text-dim transition hover:border-accent/40 hover:text-text"
            href="/models"
          >
            model picks
          </a>
          <a
            class="rounded-lg border border-border bg-surface px-3 py-2 font-mono text-[11px] text-dim transition hover:border-accent/40 hover:text-text"
            href="https://developers.cloudflare.com/workers-ai/models/"
            target="_blank"
            rel="noreferrer"
          >
            workers ai models
          </a>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>
